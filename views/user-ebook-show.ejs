<style>
    #view {
        width: 100%;
        height: 750px;
        box-shadow: 0 0 4px #ccc;
        border: 1px solid #E0E0E0;
        border-radius: 5px;
        padding: 0;
        position: relative;
        margin: 10px auto;
        /* background: white url(ajax-loader.gif) center center no-repeat; */
        /* top: calc(50vh - 400px); */
    }
    .arrow {
        font-size: 4rem;
        position: fixed;
        /* top: 50%; */
        top: calc(50% - 43px);
        margin-top: -32px;
        font-size: 64px;
        color: #E2E2E2;
        font-family: arial, sans-serif;
        font-weight: bold;
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
        text-decoration: none;
    }
    .arrow:hover {
        text-decoration: none;
        color: #e2e2e2;
    }
    #next {
        right: 40px;
    }
    #prev {
        left: 40px;
    }
</style>

<div class="row">
    <div class="col">
        <h2><%= locals.ebook.title %></h2>
    </div>
    <div class="col" style="display: none;">
        <img src="<%= locals.ebook_cover_url %>" alt="<%= locals.ebook.title %>">
    </div>
</div>
<hr>
<div class="row">
    <div class="col">
        <div id="view"></div>
        <a id="prev" href="#prev" class="arrow" style="visibility: hidden;">‹</a>
        <a id="next" href="#next" class="arrow" style="visibility: visible;">›</a>
    </div>
</div>
<hr>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.5.0/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

<script>
    $(document).ready(function() {
        var ebook_cover_url = "<%= locals.ebook_cover_url %>";
        var ebook_url = "<%= locals.ebook_url %>";

        var book = ePub(ebook_url);
        var rendition = book.renderTo("view", {
            method: "default",
            width: "100%",
            height: "750",
            spread: "always",
            flow: "paginated"
        })
        var displayed = rendition.display();

        book.ready.then(function() {
            $("#next").on("click", function(event) {
                event.preventDefault();
                rendition.next()
            })
            $("#prev").on("click", function(event) {
                event.preventDefault();
                rendition.prev()
            })

            var keyListener = function(e) {

                // Left Key
                if ((e.keyCode || e.which) == 37) {
                book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
                }

                // Right Key
                if ((e.keyCode || e.which) == 39) {
                book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
                }

            };

            rendition.on("keyup", keyListener); // TODO: is this needed?
            document.addEventListener("keyup", keyListener, false);
            $(document).on("keyup", keyListener)
        })

        // TODO: fix!
        rendition.on("relocated", function(location) {
            if (location.atEnd) {
                $("#next").css("visibility", "hidden");
            } else {
                $("#next").css("visibility", "visible");
            }

            if (location.atStart) {
                $("#prev").css("visibility", "hidden");
            } else {
                $("#prev").css("visibility", "visible");
            }
        })
    })
</script>